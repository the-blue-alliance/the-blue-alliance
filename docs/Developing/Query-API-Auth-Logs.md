# API Authentication and Request Logging in Google Cloud

## Understanding App Engine Log Structure

App Engine creates two types of logs for each request:

1. **Request Logs** (protoPayload) - Parent log entry with request/response metadata
   - Created automatically by App Engine runtime (not your Python code)
   - Contains: URL, status code, latency, user agent, traceId, spanId, etc.
   - Has a **fixed schema** - cannot add custom fields directly
   - Schema: https://cloud.google.com/appengine/docs/admin-api/reference/rest/v1/apps.services.versions.instances/debug#RequestLog

2. **Child Logs** (stdout/stderr) - Individual log lines from your application
   - Created by your Python code via `logging.info()`, `logging.error()`, etc.
   - Can include custom labels via `logging.googleapis.com/labels`
   - Associated with parent request log via trace ID

## Where Default Request Logs Come From

The request logs (protoPayload) are generated by:
- **App Engine Runtime** - Runs outside your Python application
- **Location**: `google/appengine/runtime/middlewares.py` (in the runtime environment)
- **Process**: Runtime intercepts WSGI requests/responses and logs metadata
- **Schema**: Fixed by App Engine - defined in the App Engine Logging API

You **cannot** directly modify the request log structure or add custom fields to protoPayload.

## How to Augment Request Data

While you can't modify the request log itself, you have three approaches to add searchable metadata:

### 1. ✅ Add Labels to Child Logs (Current Implementation)

**How it works:**
- Use `set_logging_context(key, value)` to add labels
- Labels appear on stderr/stdout logs (child logs)
- Labels are searchable and filterable in GCP Console

**Code:**
```python
from backend.common.logging import set_logging_context

# In your handler/decorator
set_logging_context("api_auth_key", auth_key)
set_logging_context("user_id", user_id)
```

**Where to find:**
- Child logs under each request (expand the request in Console)
- Query: `labels.api_auth_key="YOUR_KEY"`

**Implementation:**
- `src/backend/api/handlers/decorators.py` - `api_authenticated` decorator
- `src/backend/api/trusted_api_auth_helper.py` - `do_trusted_api_auth` method
- `src/backend/common/logging.py` - Logging infrastructure

### 2. ✅ Add Labels to Cloud Trace Spans

**How it works:**
- Cloud Trace spans support a `labels` field (map of string key-value pairs)
- Labels appear in Cloud Trace UI and can be used for filtering traces
- Trace ID is included in request logs (`protoPayload.traceId`)

**Code:**
```python
from backend.common.profiler import Span

# In your handler/decorator
with Span("my_operation") as span:
    span.set_label("api_auth_key", auth_key)
    span.set_label("event_key", event_key)
    # ... rest of your code
```

**Where to find:**
- Cloud Trace UI: https://console.cloud.google.com/traces
- Filter by label in Cloud Trace
- Linked from request logs via traceId

**Benefits:**
- Richer debugging context
- Performance analysis with metadata
- Can filter traces by custom labels
- Spans show timing of specific operations

**Implementation:**
- `src/backend/common/profiler.py` - `Span` class with `set_label()` method
- `src/backend/api/handlers/decorators.py` - Adds labels to `api_authenticated` span

### 3. ✅ Log Explicit Messages

**How it works:**
- Use `logging.info()` to create visible log messages
- Messages appear in child logs and are searchable
- Easier to spot when browsing logs manually

**Code:**
```python
import logging

logging.info(f"API request authenticated with key: {auth_key[:16]}...")
```

**Where to find:**
- stderr child logs under each request
- Text search in GCP Console
- Query: `textPayload:"authenticated with key"`

**Implementation:**
- `src/backend/api/handlers/decorators.py` - Logs auth info
- `src/backend/api/trusted_api_auth_helper.py` - Logs write API auth

## API Authentication Logging

When API requests are authenticated, the system automatically:
1. **Adds label**: `api_auth_key` to child logs (searchable)
2. **Adds label**: To Cloud Trace span (viewable in Trace UI)
3. **Logs message**: "API request authenticated with key: ..." (human-readable)

## How to Query Logs

### Find Requests by API Key

```
resource.type=gae_app
resource.labels.module_id=py3-api
labels.api_auth_key="YOUR_API_KEY_HERE"
```

This shows all logs from requests using that API key.

### Find All Authenticated Requests

```
resource.type=gae_app
resource.labels.module_id=py3-api
labels.api_auth_key:*
```

Shows all requests that used any API key.

### Find Write API Requests

```
resource.type=gae_app
resource.labels.module_id=py3-api
labels.api_auth_key:*
protoPayload.resource=~"/_ah/api/"
```

### View Traces for a Specific API Key

```
resource.type=gae_app
resource.labels.module_id=py3-api
labels.api_auth_key="YOUR_KEY"
```

Then click on a request's traceId link to view in Cloud Trace UI.

## Viewing in GCP Console

### Method 1: Query by Label (Recommended)
1. Go to [Cloud Logging](https://console.cloud.google.com/logs)
2. Use query builder or paste one of the queries above
3. Results show matching child logs with auth info

### Method 2: Expand Request Logs
1. Go to [Cloud Logging](https://console.cloud.google.com/logs)
2. Find a request log (has protoPayload)
3. Click the arrow to expand
4. Look at child logs (stderr entries)
5. Child logs show the `api_auth_key` label

### Method 3: View in Cloud Trace
1. Get traceId from a request log
2. Go to [Cloud Trace](https://console.cloud.google.com/traces)
3. Search by trace ID or filter by labels
4. View span details with custom labels

## Example: Find All Requests for a Specific API Key

```bash
# Via logging
gcloud logging read \
  'resource.type=gae_app AND labels.api_auth_key="frc254_key_here"' \
  --limit=50 \
  --format=json

# View associated traces
gcloud logging read \
  'resource.type=gae_app AND labels.api_auth_key="frc254_key_here"' \
  --limit=1 \
  --format=json | python3 -c \
  "import json, sys; log = json.load(sys.stdin)[0]; \
   trace_id = log.get('protoPayload', {}).get('traceId'); \
   print(f'View trace: https://console.cloud.google.com/traces/list?tid={trace_id}')"
```

## Why Request Logs Can't Be Directly Modified

App Engine request logs are created by the **App Engine runtime**, not your application:
- Generated **outside** your Python process
- Created from WSGI middleware in the runtime
- Fixed schema defined by Google Cloud Platform
- Automatically includes: method, URL, status, latency, user agent, etc.

**What you CAN control:**
- ✅ Labels on child logs (via `set_logging_context`)
- ✅ Labels on Cloud Trace spans (via `span.set_label`)
- ✅ Explicit log messages (via `logging.info`)
- ✅ Response headers (visible in request log's response metadata)

**What you CANNOT control:**
- ❌ Adding custom fields to protoPayload
- ❌ Modifying request log schema
- ❌ Adding labels directly to request logs

## See Also

- [App Engine Python 3 Logging](https://cloud.google.com/appengine/docs/standard/python3/writing-application-logs)
- [Cloud Trace Overview](https://cloud.google.com/trace/docs/overview)
- [Logging Query Language](https://cloud.google.com/logging/docs/view/logging-query-language)
- [Request Log Schema](https://cloud.google.com/appengine/docs/admin-api/reference/rest/v1/apps.services.versions.instances/debug#RequestLog)

{% macro mobility(team, did_mobility) %}
{% if did_mobility %}
<span class="glyphicon glyphicon-ok" rel="tooltip" title="{{team|digits}}"></span>
{% else %}
<span class="glyphicon glyphicon-remove" rel="tooltip" title="{{team|digits}}"></span>
{% endif %}
{% endmacro %}

{% macro coral(period, score_breakdown) %}
{% set periodKey = '%sReef'|format(period) %}
{% set countKey = '%sCoralCount'|format(period) %}
{% if periodKey in score_breakdown.red and "tba_topRowCount" in score_breakdown.red[periodKey] and "tba_midRowCount" in score_breakdown.red[periodKey] and "tba_botRowCount" in score_breakdown.red[periodKey] and "trough" in score_breakdown.red[periodKey] %}
    <tr>
        <td class="red">L4</td>
        <td class="red">{{score_breakdown.red[periodKey].tba_topRowCount}}</td>
        <td rowspan="4">{{period|title}} Coral Count</td>
        <td class="blue">{{score_breakdown.blue[periodKey].tba_topRowCount}}</td>
        <td class="blue">L4</td>
    </tr>
    <tr>
        <td class="red">L3</td>
        <td class="red">{{score_breakdown.red[periodKey].tba_midRowCount}}</td>
        <td class="blue">{{score_breakdown.blue[periodKey].tba_midRowCount}}</td>
        <td class="blue">L3</td>
    </tr>
    <tr>
        <td class="red">L2</td>
        <td class="red">{{score_breakdown.red[periodKey].tba_botRowCount}}</td>
        <td class="blue">{{score_breakdown.blue[periodKey].tba_botRowCount}}</td>
        <td class="blue">L2</td>
    </tr>
    <tr>
        <td class="red">L1</td>
        <td class="red">{{score_breakdown.red[periodKey].trough}}</td>
        <td class="blue">{{score_breakdown.blue[periodKey].trough}}</td>
        <td class="blue">L1</td>
    </tr>
{% elif countKey in score_breakdown.red %}
<tr>
    <td class="red" colspan="2">
        {{score_breakdown.red[countKey]}}
    </td>
    <td>{{period|title}} Coral Count</td>
    <td class="blue" colspan="2">
        {{score_breakdown.blue[countKey]}}
    </td>
</tr>
{% endif %}
{% endmacro %}

{% macro endgame(team, endgame_result) %}
{% if endgame_result == 'DeepCage' %}
<span rel="tooltip" title="{{team|digits}}">Deep Cage (+12)</span>
{% elif endgame_result == 'ShallowCage' %}
<span rel="tooltip" title="{{team|digits}}">Shallow Cage (+6)</span>
{% elif endgame_result == 'Parked' %}
<span rel="tooltip" title="{{team|digits}}">Parked (+2)</span>
{% else %}
<span rel="tooltip" title="{{team|digits}}" class="glyphicon glyphicon-remove"></span>
{% endif %}
{% endmacro %}

{% macro coopertition_criteria(earned) %}
{% if earned %}
<span class="glyphicon glyphicon-ok"></span>
{% else %}
<span class="glyphicon glyphicon-remove"></span>
{% endif %}
{% endmacro %}

{% macro rp_bonus(earned) %}
{% if earned %}
<span class="glyphicon glyphicon-ok"></span> (+1 RP)
{% else %}
<span class="glyphicon glyphicon-remove"></span>
{% endif %}
{% endmacro %}

{% macro fouls(alliance_breakdown) %}
{%if alliance_breakdown.foulCount%}{{alliance_breakdown.foulCount}}{%else%}0{%endif%} /
{%if alliance_breakdown.techFoulCount%}{{alliance_breakdown.techFoulCount}}{%else%}0{%endif%}
{% endmacro %}

{% macro drawReef(alliance_breakdown, row_key, is_red) %}
{% set transforms = {
  "A": "matrix(1,0,0,-1,0,120.00208)",
  "B": "",
  "C": "matrix(0.5,-0.8660254,-0.8660254,-0.5,82.086452,142.17791)",
  "D": "rotate(-60,60.248055,60.00104)",
  "E": "matrix(-0.5,-0.8660254,-0.8660254,0.5,142.33451,82.176869)",
  "F": "rotate(-120,60.248055,60.001041)",
  "G": "matrix(-1,0,0,1,120.49611,0)",
  "H": "rotate(180,60.248053,60.00104)",
  "I": "matrix(-0.5,0.8660254,0.8660254,0.5,38.409658,-22.175826)",
  "J": "rotate(120,60.248053,60.001041)",
  "K": "matrix(0.5,0.8660254,0.8660254,-0.5,-21.838398,37.825214)",
  "L": "rotate(60,60.248051,60.001042)",
} %}
<svg width="10em" height="10em" viewBox="0 0 120 120">
  <style>
    path {
      fill: #ffffff;
      fill-opacity: 1;
      stroke: #000000;
      stroke-width: 1;
      stroke-linejoin: round;
      stroke-dasharray: none;
    }
  </style>
  <g id="layer1" transform="rotate({{0 if is_red else 180}},60,60)">
    {% for position in transforms %}
      <g transform="{{ transforms[position] }}">
        <title>{{position}}</title>
        <path d="M 10,60 H 60 L 10,88.8675135 Z"
          style="fill: #00ff00; fill-opacity: {{0.3 if alliance_breakdown.autoReef[row_key]["node"+position] else 0}};"/>
        {% if alliance_breakdown.teleopReef[row_key]["node"+position] %}
          <path d="m 15,63 h 17.5 c 0,0 2.5,0 2.5,4.5 0,5 -2.5,4.5 -2.5,4.5 l -17.5,0"/>
          <path d="m 13,67.5 c 0,6 4,6 4,0 0,-6 -4,-6 -4,0 z"/>
        {% endif %}
      </g>
    {% endfor %}
  </g>
</svg>
{% endmacro %}

<table class="match-table">
    <tbody>
    <!-- Autonomous -->
    <!-- Mobility -->
    {% if "autoLineRobot1" in match.score_breakdown.red %}
    <tr class="key">
        <td class="redScore" colspan="2">
            {{mobility(match.alliances.red.teams.0, match.score_breakdown.red.autoLineRobot1 == 'Yes')}}
            {{mobility(match.alliances.red.teams.1, match.score_breakdown.red.autoLineRobot2 == 'Yes')}}
            {{mobility(match.alliances.red.teams.2, match.score_breakdown.red.autoLineRobot3 == 'Yes')}}
            (+{{match.score_breakdown.red.autoMobilityPoints}})
        </td>
        <td>Auto Leave</td>
        <td class="blueScore" colspan="2">
            {{mobility(match.alliances.blue.teams.0, match.score_breakdown.blue.autoLineRobot1 == 'Yes')}}
            {{mobility(match.alliances.blue.teams.1, match.score_breakdown.blue.autoLineRobot2 == 'Yes')}}
            {{mobility(match.alliances.blue.teams.2, match.score_breakdown.blue.autoLineRobot3 == 'Yes')}}
            (+{{match.score_breakdown.blue.autoMobilityPoints}})
        </td>
    </tr>
    {% endif %}

    <!--Auto Game Pieces-->
    {{coral('auto', match.score_breakdown)}}

    {% if "autoCoralPoints" in match.score_breakdown.red %}
    <tr class="key">
        <td class="redScore" colspan="2">
            {{match.score_breakdown.red.autoCoralPoints}}
        </td>
        <td>Auto Coral Points</td>
        <td class="blueScore" colspan="2">
            {{match.score_breakdown.blue.autoCoralPoints}}
        </td>
    </tr>
    {% endif %}

    {% if "autoPoints" in match.score_breakdown.red %}
    <tr class="key">
        <td class="redScore" colspan="2">
            <b>{{match.score_breakdown.red.autoPoints}}</b>
        </td>
        <th>Total Auto</th>
        <td class="blueScore" colspan="2">
            <b>{{match.score_breakdown.blue.autoPoints}}</b>
        </td>
    </tr>
    {% endif %}

    <!-- Teleop -->
    <!-- Game Piece Points -->
    {{coral('teleop', match.score_breakdown)}}

    {% if "teleopCoralPoints" in match.score_breakdown.red %}
    <tr class="key">
        <td class="redScore" colspan="2">
            {{match.score_breakdown.red.teleopCoralPoints}}
        </td>
        <td>Teleop Coral Points</td>
        <td class="blueScore" colspan="2">
            {{match.score_breakdown.blue.teleopCoralPoints}}
        </td>
    </tr>
    {% endif %}

    {% if "wallAlgaeCount" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{match.score_breakdown.red.wallAlgaeCount}}
        </td>
        <td>Processor Algae Count</td>
        <td class="blue" colspan="2">
            {{match.score_breakdown.blue.wallAlgaeCount}}
        </td>
    </tr>
    {% endif %}

    {% if "netAlgaeCount" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{match.score_breakdown.red.netAlgaeCount}}
        </td>
        <td>Net Algae Count</td>
        <td class="blue" colspan="2">
            {{match.score_breakdown.blue.netAlgaeCount}}
        </td>
    </tr>
    {% endif %}

    {% if "algaePoints" in match.score_breakdown.red %}
    <tr class="key">
        <td class="redScore" colspan="2">
            {{match.score_breakdown.red.algaePoints}}
        </td>
        <td>Algae Points</td>
        <td class="blueScore" colspan="2">
            {{match.score_breakdown.blue.algaePoints}}
        </td>
    </tr>
    {% endif %}

    <!-- Endgame -->
    {% if "endGameRobot1" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{endgame(match.alliances.red.teams.0, match.score_breakdown.red.endGameRobot1)}}
        </td>
        <td>Robot 1 Endgame</td>
        <td class="blue" colspan="2">
            {{endgame(match.alliances.blue.teams.0, match.score_breakdown.blue.endGameRobot1)}}
        </td>
    </tr>
    {% endif %}

    {% if "endGameRobot2" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{endgame(match.alliances.red.teams.1, match.score_breakdown.red.endGameRobot2)}}
        </td>
        <td>Robot 2 Endgame</td>
        <td class="blue" colspan="2">
            {{endgame(match.alliances.blue.teams.1, match.score_breakdown.blue.endGameRobot2)}}
        </td>
    </tr>
    {% endif %}

    {% if "endGameRobot3" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{endgame(match.alliances.red.teams.2, match.score_breakdown.red.endGameRobot3)}}
        </td>
        <td>Robot 3 Endgame</td>
        <td class="blue" colspan="2">
            {{endgame(match.alliances.blue.teams.2, match.score_breakdown.blue.endGameRobot3)}}
        </td>
    </tr>
    {% endif %}

    {% if "endGameBargePoints" in match.score_breakdown.red %}
    <tr class="key">
        <td class="redScore" colspan="2">
            {{match.score_breakdown.red.endGameBargePoints}}
        </td>
        <td>Barge Points</td>
        <td class="blueScore" colspan="2">
            {{match.score_breakdown.blue.endGameBargePoints}}
        </td>
    </tr>
    {% endif %}

    <!-- Teleop Score -->
    {% if "teleopPoints" in match.score_breakdown.red %}
    <tr class="key">
        <td class="redScore" colspan="2">
            <b>{% if match.score_breakdown.red.teleopPoints
                %}{{match.score_breakdown.red.teleopPoints}}{%else%}0{%endif%}</b>
        </td>
        <th>Total Teleop</th>
        <td class="blueScore" colspan="2">
            <b>{% if match.score_breakdown.blue.teleopPoints
                %}{{match.score_breakdown.blue.teleopPoints}}{%else%}0{%endif%}</b>
        </td>
    </tr>
    {% endif %}

    <!-- Coop -->
    {% if "coopertitionCriteriaMet" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{coopertition_criteria(match.score_breakdown.red.coopertitionCriteriaMet)}}
        </td>
        <td>Coopertition Criteria Met</td>
        <td class="blue" colspan="2">
            {{coopertition_criteria(match.score_breakdown.blue.coopertitionCriteriaMet)}}
        </td>
    </tr>
    {% endif %}

    <!-- Bonus RP -->
    {% if "autoBonusAchieved" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{rp_bonus(match.score_breakdown.red.autoBonusAchieved)}}
        </td>
        <td>Auto Bonus</td>
        <td class="blue" colspan="2">
            {{rp_bonus(match.score_breakdown.blue.autoBonusAchieved)}}
        </td>
    </tr>
    {% endif %}

    {% if "coralBonusAchieved" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{rp_bonus(match.score_breakdown.red.coralBonusAchieved)}}
        </td>
        <td>Coral Bonus</td>
        <td class="blue" colspan="2">
            {{rp_bonus(match.score_breakdown.blue.coralBonusAchieved)}}
        </td>
    </tr>
    {% endif %}

    {% if "bargeBonusAchieved" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{rp_bonus(match.score_breakdown.red.bargeBonusAchieved)}}
        </td>
        <td>Barge Bonus</td>
        <td class="blue" colspan="2">
            {{rp_bonus(match.score_breakdown.blue.bargeBonusAchieved)}}
        </td>
    </tr>
    {% endif %}

    <!-- Fouls & Adjustments -->
    {% if "foulCount" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">
            {{fouls(match.score_breakdown.red)}}
        </td>
        <td>Fouls / Tech Fouls</td>
        <td class="blue" colspan="2">
            {{fouls(match.score_breakdown.blue)}}
        </td>
    </tr>
    {% endif %}

    {% if "foulPoints" in match.score_breakdown.red %}
    <tr class="key">
        <td class="redScore" colspan="2">
            {{match.score_breakdown.red.foulPoints}}
        </td>
        <td>Foul Points</td>
        <td class="blueScore" colspan="2">
            {{match.score_breakdown.blue.foulPoints}}
        </td>
    </tr>
    {% endif %}

    {% if "adjustPoints" in match.score_breakdown.red %}
    <tr>
        <td class="red" colspan="2">{% if
            match.score_breakdown.red.adjustPoints%}{{match.score_breakdown.red.adjustPoints}}{%else%}0{%endif%}</td>
        <td>Adjustments</td>
        <td class="blue" colspan="2">{%if
            match.score_breakdown.blue.adjustPoints%}{{match.score_breakdown.blue.adjustPoints}}{%else%}0{%endif%}</td>
    </tr>
    {% endif %}

    <tr class="key">
      <td class="redScore" colspan="2"><b>{%if match.score_breakdown.red.totalPoints%}{{match.score_breakdown.red.totalPoints}}{%else%}0{%endif%}</b></td>
      <th>Total Score</th>
      <td class="blueScore" colspan="2"><b>{%if match.score_breakdown.blue.totalPoints%}{{match.score_breakdown.blue.totalPoints}}{%else%}0{%endif%}</b></td>
    </tr>

    <tr>
      <td class="red" colspan="2">
        {% if match.score_breakdown.red.autoBonusAchieved %}
        <svg class="top-left-dot" rel="tooltip" title="Auto Bonus">
          <circle cx="2" cy="2" r="2"/>
        </svg>
        {% endif %}
        {% if match.score_breakdown.red.coralBonusAchieved %}
        <svg class="top-left-dot-2" rel="tooltip" title="Coral Bonus">
          <circle cx="2" cy="2" r="2"/>
        </svg>
        {% endif %}
        {% if match.score_breakdown.red.bargeBonusAchieved %}
        <svg class="top-left-dot-2" rel="tooltip" title="Barge Bonus">
          <circle cx="2" cy="2" r="2"/>
        </svg>
        {% endif %}
        +{{match.score_breakdown.red.rp}} RP
      </td>
      <td>Ranking Points</td>
      <td class="blue" colspan="2">
        {% if match.score_breakdown.blue.autoBonusAchieved %}
        <svg class="top-left-dot" rel="tooltip" title="Auto Bonus">
          <circle cx="2" cy="2" r="2"/>
        </svg>
        {% endif %}
        {% if match.score_breakdown.blue.coralBonusAchieved %}
        <svg class="top-left-dot-2" rel="tooltip" title="Coral Bonus">
          <circle cx="2" cy="2" r="2"/>
        </svg>
        {% endif %}
        {% if match.score_breakdown.blue.bargeBonusAchieved %}
        <svg class="top-left-dot-2" rel="tooltip" title="Barge Bonus">
            <circle cx="2" cy="2" r="2" />
        </svg>
        {% endif %}
        +{{match.score_breakdown.blue.rp}} RP
      </td>
    </tr>
    </tbody>
</table>

{% if "teleopReef" in match.score_breakdown.red %}
<h4>Scoring Location Breakdown</h4>
<table class="match-table">
  <tbody>
    <tr>
      <td class="red">
        {{drawReef(match.score_breakdown.red, "topRow", True)}}
      </td>
      <td>
        High (L4)
      </td>
      <td class="blue">
        {{drawReef(match.score_breakdown.blue, "topRow", False)}}
      </td>
    </tr>
    <tr>
      <td class="red">
        {{drawReef(match.score_breakdown.red, "midRow", True)}}
      </td>
      <td>
        Mid (L3)
      </td>
      <td class="blue">
        {{drawReef(match.score_breakdown.blue, "midRow", False)}}
      </td>
    </tr>
    <tr>
      <td class="red">
        {{drawReef(match.score_breakdown.red, "botRow", True)}}
      </td>
      <td>
        Low (L2)
      </td>
      <td class="blue">
        {{drawReef(match.score_breakdown.blue, "botRow", False)}}
      </td>
    </tr>
    <tr>
      <td class="red">
        {{match.score_breakdown.red.teleopReef.trough}}
      </td>
      <td>
        Trough (L1)
      </td>
      <td class="blue">
        {{match.score_breakdown.blue.teleopReef.trough}}
      </td>
    </tr>
  </tbody>
</table>
<div style="display: flex; flex-direction: row; align-items: center;">
    <svg width="24px" height="24px" viewBox="12.5 62.5 25 10" style="margin-right: 8px;">
        <style>
        path {
            fill: #ffffff;
            fill-opacity: 1;
            stroke: #000000;
            stroke-width: 1;
            stroke-linejoin: round;
            stroke-dasharray: none;
        }
        </style>
        <path d="m 15,63 h 17.5 c 0,0 2.5,0 2.5,4.5 0,5 -2.5,4.5 -2.5,4.5 l -17.5,0"/>
        <path d="m 13,67.5 c 0,6 4,6 4,0 0,-6 -4,-6 -4,0 z"/>
    </svg>
    Coral
</div>
<div style="display: flex; flex-direction: row; align-items: center;">
    <svg width="24px" height="24px" style="margin-right: 8px;">
        <rect width="24" height="24" style="fill:rgb(0,255,0,0.3); stroke-width:1; stroke:rgb(0,0,0,0.2)" />
    </svg>
    Scored in auto
</div>
{% endif %}

{% if has_coprs %}
<h3><abbr title="Component Offensive Power Ratings">COPRs</abbr> (<a href="/opr">?</a>)</h3>
<div class="btn-group">
  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
          aria-expanded="false">
    <span id="coprSelector">Choose component</span> <span class="caret"></span>
  </button>
    <button type="button" class="btn btn-default" id="copr_csv">Download CSV</button>
  <ul class="dropdown-menu">
    <li>
        <a href="#" id="copr_clear">Clear (reset to OPR)</a>
    </li>
    <li role="separator" class="divider"></li>
    {% for copr_item in copr_items %}
        <li>
            <label class="copr-select" data-key="{{ copr_item[0] }}" data-name="{{ copr_item[2] }}" for="checkbox_{{ copr_item[1] }}" style="display:block; padding:3px 12px; cursor:pointer;">
                <input type="checkbox" id="checkbox_{{ copr_item[1] }}" style="margin-right:6px;">{{ copr_item[2] }}
            </label>
        </li>
    {% endfor %}
  </ul>
</div>

<table class="table table-condensed table-striped table-center table-hover" style="table-layout: fixed;">
    <thead>
        <tr>
            <th>#</th>
            <th>Team</th>
            <th id="componentColHeader"><abbr title="Component Offensive Power Rating">COPR</abbr></th>
        </tr>
    </thead>
    <tbody id="coprTableBody">
    </tbody>
</table>

<script>
    const coprs = JSON.parse('{{ coprs_json|safe }}');

    // Sorting state: index (column index), dir (1 = asc, -1 = desc)
    let sortState = { index: null, dir: 1 };

    function clearSortIndicators() {
        document.querySelectorAll('#coprTableBody').forEach(() => {}); // noop to keep consistent selection usage
        const ths = document.querySelectorAll('table thead tr th');
        ths.forEach(t => {
            const ind = t.querySelector('.sort-indicator');
            if (ind) ind.remove();
        });
    }

    function setSortIndicator(th, dir) {
        // remove existing indicators first
        clearSortIndicators();
        const span = document.createElement('span');
        span.className = 'sort-indicator';
        span.style.marginLeft = '6px';
        span.innerText = dir === 1 ? '▲' : '▼';
        th.appendChild(span);
    }

    function getCellValueForSort(cell, type) {
        if (!cell) return null;
        const txt = cell.innerText.trim();
        if (type === 'number') {
            const n = parseFloat(txt.replace(',', ''));
            return Number.isFinite(n) ? n : NaN;
        }
        // default: string
        return txt.toLowerCase();
    }

    function sortTableRows(tbody, colIndex, type, dir) {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const aCell = a.children[colIndex];
            const bCell = b.children[colIndex];
            const aVal = getCellValueForSort(aCell, type);
            const bVal = getCellValueForSort(bCell, type);

            // Handle NaN for numeric by pushing to bottom
            if (type === 'number') {
                const aNaN = Number.isNaN(aVal);
                const bNaN = Number.isNaN(bVal);
                if (aNaN && bNaN) return 0;
                if (aNaN) return 1;
                if (bNaN) return -1;
            }

            if (aVal < bVal) return -1 * dir;
            if (aVal > bVal) return 1 * dir;
            return 0;
        });

        // Re-append in sorted order
        rows.forEach(r => tbody.appendChild(r));
    }

    // Helper: return teams in the order of the primary component (first selected)
    function getPrimaryTeamList(primaryComponent) {
        if (!coprs[primaryComponent]) return [];
        return coprs[primaryComponent].map(e => e[0]);
    }

    function buildCoprTable(selectedComponents) {
        const theadRow = document.querySelector('#coprTableBody').parentElement.querySelector('thead tr');
        const tbody = document.getElementById('coprTableBody');

        // Build header: fixed columns + one per selected component
        theadRow.innerHTML = '';
        const thRank = document.createElement('th');
        thRank.innerText = '#';
        theadRow.appendChild(thRank);

        const thTeam = document.createElement('th');
        thTeam.innerText = 'Team';
        theadRow.appendChild(thTeam);

        selectedComponents.forEach(comp => {
            const th = document.createElement('th');
            th.innerHTML = `<abbr title="Component Offensive Power Rating">${comp.readable}</abbr>`;
            // mark component columns as sortable (type=number)
            th.setAttribute('data-sort-type', 'number');
            theadRow.appendChild(th);
        });

        // Build body
        tbody.innerHTML = '';
        if (selectedComponents.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 2;
            td.innerText = 'No components selected';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        const primaryKey = selectedComponents[0].key;
        const teams = getPrimaryTeamList(primaryKey);

        teams.forEach((teamId, idx) => {
            const tr = document.createElement('tr');

            const rankTd = document.createElement('td');
            rankTd.innerText = idx + 1;
            tr.appendChild(rankTd);

            const teamLink = document.createElement('a');
            teamLink.href = `/team/${teamId}/{{ event.year }}`;
            teamLink.innerText = teamId;
            const teamTd = document.createElement('td');
            teamTd.appendChild(teamLink);
            tr.appendChild(teamTd);

            // For each selected component, find value for this team
            selectedComponents.forEach(comp => {
                const coprTd = document.createElement('td');
                const list = coprs[comp.key] || [];
                const found = list.find(e => e[0] === teamId);
                coprTd.innerText = found ? found[1].toFixed(2) : '-';
                tr.appendChild(coprTd);
            });

            tbody.appendChild(tr);
        });

        // After building header/body, attach sorting handlers to headers.
        const ths = theadRow.querySelectorAll('th');
        ths.forEach((th, idx) => {
            // determine column type: rank (number), team (string), others (number)
            let type = th.getAttribute('data-sort-type');
            if (!type) {
                if (idx === 0) type = 'number';
                else if (idx === 1) type = 'string';
                else type = 'number';
            }
            th.style.cursor = 'pointer';
            th.addEventListener('click', function() {
                // toggle sort
                if (sortState.index === idx) {
                    sortState.dir = -sortState.dir;
                } else {
                    sortState.index = idx;
                    sortState.dir = 1;
                }
                setSortIndicator(th, sortState.dir);
                sortTableRows(tbody, idx, type, sortState.dir);
            });
        });
    }

    function updateSelectorText(selectedComponents) {
        const el = document.getElementById('coprSelector');
        if (!el) return;
        if (selectedComponents.length === 0) {
            el.innerText = 'Choose component(s)';
            return;
        }
        el.innerText = selectedComponents.map(c => c.readable).join(', ');
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Initialize: wire up checkboxes and derive initial selection from current DOM state
        const checkboxNodes = document.querySelectorAll('.copr-select');
        // Helper to compute and apply selection state
        function handleSelectionChange() {
            const newSelected = [];
            document.querySelectorAll('.copr-select').forEach(n => {
                const c = n.getAttribute('data-key');
                const r = n.getAttribute('data-name');
                const icb = n.querySelector('input[type=checkbox]');
                if (icb && icb.checked) {
                    newSelected.push({ key: c, readable: r });
                }
            });
            updateSelectorText(newSelected);
            buildCoprTable(newSelected);
        }

        checkboxNodes.forEach(node => {
            const key = node.getAttribute('data-key');
            const name = node.getAttribute('data-name');
            const input = node.querySelector('input[type=checkbox]');

            // Respond to direct checkbox interactions. Rely on change events for accessibility and simplicity.
            if (input) {
                input.addEventListener('change', function(e) {
                    e.stopPropagation();
                    handleSelectionChange();
                });
            }
        });

        // Compute initial selected components from current checkbox states (honor server-rendered checked attrs)
        const initialSelected = [];
        document.querySelectorAll('.copr-select').forEach(n => {
            const c = n.getAttribute('data-key');
            const r = n.getAttribute('data-name');
            const icb = n.querySelector('input[type=checkbox]');
            if (icb && icb.checked) {
                initialSelected.push({ key: c, readable: r });
            }
        });

        // If nothing was pre-selected, select OPR by default if exists in list
        if (initialSelected.length === 0) {
            const oprNode = document.querySelector('.copr-select[data-key="OPR"]');
            if (oprNode) {
                const cb = oprNode.querySelector('input[type=checkbox]');
                if (cb) { cb.checked = true; }
                initialSelected.push({ key: 'OPR', readable: 'OPR' });
            }
        }

        updateSelectorText(initialSelected);
        buildCoprTable(initialSelected);

            // CSV download handler: export current table view
            const csvBtn = document.getElementById('copr_csv');
            if (csvBtn) {
                csvBtn.addEventListener('click', function() {
                    const table = document.querySelector('table');
                    if (!table) return;
                    const rows = [];

                    // Headers
                    const headerThs = Array.from(table.querySelectorAll('thead th'));
                    const headers = headerThs.map(th => {
                        // remove sort indicator arrows
                        return th.innerText.replace(/▲|▼/g, '').trim();
                    });
                    rows.push(headers);

                    // Body
                    const bodyRows = Array.from(table.querySelectorAll('tbody tr'));
                    bodyRows.forEach(tr => {
                        const cells = Array.from(tr.children).map(td => td.innerText.replace(/\n/g, ' ').trim());
                        rows.push(cells);
                    });

                    // Convert to CSV with proper escaping
                    const csvLines = rows.map(cols => cols.map(val => {
                        if (val == null) return '';
                        const s = String(val);
                        // escape double quotes
                        const escaped = s.replace(/"/g, '""');
                        // wrap in quotes if contains comma, quote, or newline
                        if (/[",\n]/.test(s)) {
                            return '"' + escaped + '"';
                        }
                        return escaped;
                    }).join(','));

                    // Prepend BOM for Excel compatibility
                    const bom = '\uFEFF';
                    const csvContent = bom + csvLines.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const filename = `team_stats_{{ event.key_name }}.csv`;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                });
            }

        // Clear handler: reset to only OPR selected
        const clearEl = document.getElementById('copr_clear');
        if (clearEl) {
            clearEl.addEventListener('click', function(e) {
                e.preventDefault();
                // Uncheck everything except OPR
                document.querySelectorAll('.copr-select').forEach(n => {
                    const k = n.getAttribute('data-key');
                    const icb = n.querySelector('input[type=checkbox]');
                    if (icb) {
                        icb.checked = (k === 'OPR');
                    }
                });
                // Apply change
                handleSelectionChange();
            });
        }
    });
</script>

{% endif %}
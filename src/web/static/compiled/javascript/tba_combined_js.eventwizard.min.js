function makeRequest(request_path,request_body,feedback){var auth_id=$("#auth_id").val(),auth_secret=$("#auth_secret").val(),auth_sig=CryptoJS.MD5(auth_secret+request_path+request_body).toString();$.ajax({type:"POST",url:request_path,dataType:"json",contentType:"application/json",headers:{"X-TBA-Auth-Id":auth_id,"X-TBA-Auth-Sig":auth_sig},data:request_body,success:function(data){feedback.css("background-color","#419641")},error:function(data){feedback.css("background-color","#c12e2a"),alert(data.responseText)}})}function getYoutubeId(url){var match=url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);return match&&11==match[2].length?match[2]:null}function cleanTeamNum(number){return number.toString().trim().replace("*","")}function updateMatchScore(cell,e){e.preventDefault(),cell.parent().css("background-color","#eb9316");for(var matchKey=cell.attr("data-matchKey"),redEls=$("[data-matchKey-redTeam='"+matchKey+"']"),blueEls=$("[data-matchKey-blueTeam='"+matchKey+"']"),redTeams=[],blueTeams=[],i=0;i<redEls.length;i++)redTeams.push("frc"+redEls[i].textContent);for(i=0;i<blueEls.length;i++)blueTeams.push("frc"+blueEls[i].textContent);var redScore=parseInt($("#"+matchKey+"-redScore")[0].value),blueScore=parseInt($("#"+matchKey+"-blueScore")[0].value),match={comp_level:cell.attr("data-matchCompLevel"),set_number:parseInt(cell.attr("data-matchSetNumber")),match_number:parseInt(cell.attr("data-matchNumber")),alliances:{red:{teams:redTeams,score:redScore},blue:{teams:blueTeams,score:blueScore}}},request_body=JSON.stringify([match]);makeRequest("/api/trusted/v1/event/"+$("#event_key").val()+"/matches/update",request_body,cell.parent());var video_request={},video_key=getYoutubeId($("#"+matchKey+"_video").val());video_key&&(video_request[matchKey.split("_")[1]]=video_key,makeRequest("/api/trusted/v1/event/"+$("#event_key").val()+"/match_videos/add",JSON.stringify(video_request),$("#"+matchKey+"_video").parent()))}function updateRankings(cell){cell.parent().css("background-color","#eb9316"),$.ajax({type:"GET",url:"http://10.0.100.5/Pit/GetData?random="+Math.random(),dataType:"json",cache:!1,timeout:5e3,success:function(data){console.log(data);var request_body={},breakdowns=["RS","Sort2","Sort3","Sort4","Sort 5","Wins","Losses","Ties","Played","DQ"],display=["Ranking Score","Auto","Scale/Challenge","Goals","Defense","Wins","Losses","Ties","Played","DQ"],rankData=data.Ranks;request_body.breakdowns=display,request_body.rankings=[];for(var i=0;i<rankData.length;i++){rankData[i].Team="frc"+rankData[i].Team;var teamRank={};teamRank.team_key=rankData[i].Team,teamRank.rank=rankData[i].Rank,teamRank.played=rankData[i].Played;for(var j=teamRank.dqs=0;j<breakdowns.length;j++)teamRank[display[j]]=Number(rankData[i][breakdowns[j]].toString().replace(",",""));request_body.rankings.push(teamRank)}makeRequest("/api/trusted/v1/event/"+$("#event_key").val()+"/rankings/update",JSON.stringify(request_body),cell.parent())},error:function(error){console.log(error),alert("Error getting rankings. Are you sure you're connected to the field network?"),cell.parent().css({"background-color":"#c12e2a"})}})}$("#teams-ok").click(function(){if(!$("#team_list").val())return alert("Please enter team data."),!0;for(var teams=$("#team_list").val().split("\n"),i=0;i<teams.length;i++){var teamNum=parseInt(teams[i]);if(!teamNum||isNaN(teamNum)||teamNum<=0||9999<teamNum)return alert("Invalid team "+teams[i]),!0;teams[i]="frc"+teamNum}$(this).css("background-color","#eb9316"),makeRequest("/api/trusted/v1/event/"+$("#event_key").val()+"/team_list/update",JSON.stringify(teams),$(this))}),$("#alliances-ok").click(function(){for(var request=[],count=0,count=1;count<=NUM_ALLIANCES;count++){var alliance=[],captain=$("#alliance"+count+"-captain").val(),pick1=$("#alliance"+count+"-pick1").val(),pick2=$("#alliance"+count+"-pick2").val(),pick3=$("#alliance"+count+"-pick3").val();captain?(alliance.push("frc"+captain),pick1&&alliance.push("frc"+pick1),pick2&&alliance.push("frc"+pick2),pick3&&alliance.push("frc"+pick3),request.push(alliance)):request.push([])}$(this).css("background-color","#eb9316"),makeRequest("/api/trusted/v1/event/"+$("#event_key").val()+"/alliance_selections/update",JSON.stringify(request),$(this))}),$("#schedule_file").change(function(){var f=this.files[0],reader=new FileReader;f.name;reader.onload=function(e){var data=e.target.result,workbook=XLSX.read(data,{type:"binary"}),first_sheet=workbook.SheetNames[0],sheet=workbook.Sheets[first_sheet],matches=XLSX.utils.sheet_to_json(sheet,{range:4}),request_body=[];$("#schedule_preview").empty(),$("#schedule_preview").html("<tr><th>Time</th><th>Description</th><th>Match</th><th>TBA Key</th><th>Blue 1</th><th>Blue 2</th><th>Blue 3</th><th>Red 1</th><th>Red 2</th><th>Red 3</th></tr>");for(var filter=$('input[name="import-comp-level"]:checked').val(),i=0;i<matches.length;i++){var compLevel,has_octo,setAndMatch,setNumber,matchNumber,matchKey,row,rawMatchNumber,match=matches[i];match.Description&&match["Red 1"]&&(has_octo="16"==$('input[name="alliance-count-schedule"]:checked').val(),rawMatchNumber=match.Match?parseInt(match.Match):0<=match.Description.indexOf("#")?parseInt(match.Description.split("#")[1]):parseInt(match.Description.split(" ")[1]),matchKey=match.hasOwnProperty("Description")&&0!=match.Description.indexOf("Qualification")?(compLevel=playoffTypeFromNumber(rawMatchNumber,has_octo))+(setNumber=(setAndMatch=playoffMatchAndSet(rawMatchNumber,has_octo))[0])+"m"+(matchNumber=setAndMatch[1]):(setNumber=1,(compLevel="qm")+(matchNumber=parseInt(match.Description.split(" ")[1]))),"all"!=filter&&filter!=compLevel||((row=$("<tr>")).append($("<td>").html(match.Time)),row.append($("<td>").html(match.Description)),row.append($("<td>").html(rawMatchNumber)),row.append($("<td>").html($("#event_key").val()+"_"+matchKey)),row.append($("<td>").html(cleanTeamNum(match["Blue 1"]))),row.append($("<td>").html(cleanTeamNum(match["Blue 2"]))),row.append($("<td>").html(cleanTeamNum(match["Blue 3"]))),row.append($("<td>").html(cleanTeamNum(match["Red 1"]))),row.append($("<td>").html(cleanTeamNum(match["Red 2"]))),row.append($("<td>").html(cleanTeamNum(match["Red 3"]))),$("#schedule_preview").append(row),request_body.push({comp_level:compLevel,set_number:setNumber,match_number:matchNumber,alliances:{red:{teams:["frc"+cleanTeamNum(match["Red 1"]),"frc"+cleanTeamNum(match["Red 2"]),"frc"+cleanTeamNum(match["Red 3"])],score:null},blue:{teams:["frc"+cleanTeamNum(match["Blue 1"]),"frc"+cleanTeamNum(match["Blue 2"]),"frc"+cleanTeamNum(match["Blue 3"])],score:null}},time_string:match.Time})))}0<request_body.length?($("#schedule_preview_status").html("Loaded "+request_body.length+" matches"),$("#schedule_preview").show(),$("#schedule-ok").show(),$("#schedule-ok").unbind("click").click(function(){$(this).css("background-color","#eb9316"),makeRequest("/api/trusted/v1/event/"+$("#event_key").val()+"/matches/update",JSON.stringify(request_body),$(this))})):$("#schedule_preview_status").html("No matches found in the file.")},$("#schedule_preview_status").html("Loading..."),reader.readAsBinaryString(f)}),$("#results_file").change(function(){var f=this.files[0],reader=new FileReader;f.name;reader.onload=function(e){var data=e.target.result,workbook=XLSX.read(data,{type:"binary"}),first_sheet=workbook.SheetNames[0],sheet=workbook.Sheets[first_sheet],matches=XLSX.utils.sheet_to_json(sheet,{range:2}),request_body=[];$("#results_preview").empty(),$("#results_preview").html("<tr><th>Time</th><th>Match</th><th>TBA Key</th><th>Red 1</th><th>Red 2</th><th>Red 3</th><th>Blue 1</th><th>Blue 2</th><th>Blue 3</th><th>Red Score</th><th>Blue Score</th></tr>");for(var last_match_type=null,i=0;i<matches.length;i++){var has_octo,levelSetAndMatch,compLevel,setNumber,matchNumber,matchKey,row,match=matches[i];match.Time&&(has_octo="16"==$('input[name="alliance-count-results"]:checked').val(),matchKey=match.Match.includes("Qualification")?(setNumber=1,(compLevel="qm")+(matchNumber=parseInt(match.Match.split(" ")[1]))):(compLevel=(levelSetAndMatch=playoffTypeMatchAndSet(has_octo,match.Match,last_match_type))[0])+(setNumber=levelSetAndMatch[1])+"m"+(matchNumber=levelSetAndMatch[2]),last_match_type=compLevel,(row=$("<tr>")).append($("<td>").html(match.Time)),row.append($("<td>").html(match.Match)),row.append($("<td>").html($("#event_key").val()+"_"+matchKey)),row.append($("<td>").html(cleanTeamNum(match["Red 1"]))),row.append($("<td>").html(cleanTeamNum(match["Red 2"]))),row.append($("<td>").html(cleanTeamNum(match["Red 3"]))),row.append($("<td>").html(cleanTeamNum(match["Blue 1"]))),row.append($("<td>").html(cleanTeamNum(match["Blue 2"]))),row.append($("<td>").html(cleanTeamNum(match["Blue 3"]))),row.append($("<td>").html(match["Red Score"])),row.append($("<td>").html(match["Blue Score"])),$("#results_preview").append(row),request_body.push({comp_level:compLevel,set_number:setNumber,match_number:matchNumber,alliances:{red:{teams:["frc"+cleanTeamNum(match["Red 1"]),"frc"+cleanTeamNum(match["Red 2"]),"frc"+cleanTeamNum(match["Red 3"])],score:parseInt(match["Red Score"])},blue:{teams:["frc"+cleanTeamNum(match["Blue 1"]),"frc"+cleanTeamNum(match["Blue 2"]),"frc"+cleanTeamNum(match["Blue 3"])],score:parseInt(match["Blue Score"])}},time_string:match.Time}))}0<request_body.length?($("#results_preview_status").html("Loaded "+request_body.length+" matches"),$("#results_preview").show(),$("#results-ok").show(),$("#results-ok").unbind("click").click(function(){$(this).css("background-color","#eb9316"),makeRequest("/api/trusted/v1/event/"+$("#event_key").val()+"/matches/update",JSON.stringify(request_body),$(this))})):$("#results_preview_status").html("No matches found in the file.")},$("#schedule_preview_status").html("Loading..."),reader.readAsBinaryString(f)}),$("#rankings_file").change(function(){var f=this.files[0],reader=new FileReader;f.name;reader.onload=function(e){var data=e.target.result,workbook=XLSX.read(data,{type:"binary"}),first_sheet=workbook.SheetNames[0],sheet=workbook.Sheets[first_sheet],rankings=XLSX.utils.sheet_to_json(sheet,{range:4}),request_body={},headers=["Rank","Team","RS","Cargo Pts","Panel Pts","HAB Pts","Sandstorm","W-L-T","DQ","Played"],display_headers=["Rank","Team","Ranking Score","Cargo","Hatch Panel","HAB Climb","Sandstorm Bonus","Record (W-L-T)","DQ","Played"],is_num=[!0,!0,!0,!0,!0,!1,!0,!0];$("#rankings_preview").empty(),$("#rankings_preview").html("<tr><th>"+display_headers.join("</th><th>")+"</th></tr>"),request_body.breakdowns=display_headers.slice(2,8),request_body.rankings=[];for(var i=0;i<rankings.length;i++){var rank=rankings[i];if(rank.Rank&&!isNaN(rank.Rank)){for(var row=$("<tr>"),j=0;j<headers.length;j++)row.append($("<td>").html(rank[headers[j]]));$("#rankings_preview").append(row);var breakdown={};breakdown.team_key="frc"+rank.Team,breakdown.rank=parseInt(rank.Rank),breakdown.played=parseInt(rank.Played),breakdown.dqs=parseInt(rank.DQ);for(j=0;j<request_body.breakdowns.length;j++){var val=rank[headers[j+2]];breakdown[request_body.breakdowns[j]]=is_num[j]?Number(val.toString().replace(",","")):val}request_body.rankings.push(breakdown)}}0<request_body.rankings.length?($("#rankings_preview_status").html("Loaded rankings for "+request_body.rankings.length+" teams"),$("#rankings_preview").show(),$("#rankings-ok").show(),$("#rankings-ok").unbind("click").click(function(){$(this).css("background-color","#eb9316"),makeRequest("/api/trusted/v1/event/"+$("#event_key").val()+"/rankings/update",JSON.stringify(request_body),$(this))})):$("#rankings_preview_status").html("No rankings found in the file.")},$("#schedule_preview_status").html("Loading..."),reader.readAsBinaryString(f)}),$("#teams_file").change(function(){var f=this.files[0],reader=new FileReader;f.name;reader.onload=function(e){var data=e.target.result,workbook=XLSX.read(data,{type:"binary"}),first_sheet=workbook.SheetNames[0],sheet=workbook.Sheets[first_sheet],teams=XLSX.utils.sheet_to_json(sheet,{range:2}),request_body={};$("#teams_preview").empty(),$("#teams_preview").html("<tr><th>Team Number</th><th>Team Name</th></tr>");for(var request_body=[],i=0;i<teams.length;i++){var team=teams[i];if(team["#"]){var teamNum=parseInt(team["#"]);if(!teamNum||isNaN(teamNum)||teamNum<=0||9999<teamNum)return alert("Invalid team "+teams[i]),!0;request_body[i]="frc"+teamNum;var row=$("<tr>");row.append($("<td>").html(teamNum)),row.append($("<td>").html(team["Short Name"])),$("#teams_preview").append(row)}}0<request_body.length?($("#teams_preview_status").html("Loaded "+request_body.length+" teams"),$("#teams_preview").show(),$("#fmsteams-ok").show(),$("#fmsteams-ok").unbind("click").click(function(){$(this).css("background-color","#eb9316"),makeRequest("/api/trusted/v1/event/"+$("#event_key").val()+"/team_list/update",JSON.stringify(request_body),$(this))})):$("#teams_preview_status").html("No teams found in the file.")},$("#schedule_preview_status").html("Loading..."),reader.readAsBinaryString(f)}),$("#match-table").on("click","button",function(e){"update-rankings"==$(this).attr("class")?updateRankings($(this)):"update-match"==$(this).attr("class")&&updateMatchScore($(this),e)});var ALLIANCE_PICKS_MAX=3,NUM_ALLIANCES=8;function generateAllianceTable(size,table){for(var i=size;0<i;i--){var row=$("<tr>");row.append($("<td>").html("Alliance "+i)),row.append($("<td>",{class:"captain"}).append($("<input>",{id:"alliance"+i+"-captain",placeholder:"Captain "+i})));for(var j=1;j<=ALLIANCE_PICKS_MAX;j++)row.append($("<td>",{class:"pick-"+j}).append($("<input>",{class:"pick-"+j,id:"alliance"+i+"-pick"+j,placeholder:"Pick "+i+"-"+j})));table.after(row)}}ELIM_MAPPING={1:[1,1],2:[2,1],3:[3,1],4:[4,1],5:[1,2],6:[2,2],7:[3,2],8:[4,2],9:[1,3],10:[2,3],11:[3,3],12:[4,3],13:[1,1],14:[2,1],15:[1,2],16:[2,2],17:[1,3],18:[2,3],19:[1,1],20:[1,2],21:[1,3]},OCTO_ELIM_MAPPING={1:[1,1],2:[2,1],3:[3,1],4:[4,1],5:[5,1],6:[6,1],7:[7,1],8:[8,1],9:[1,2],10:[2,2],11:[3,2],12:[4,2],13:[5,2],14:[6,2],15:[7,2],16:[8,2],17:[1,3],18:[2,3],19:[3,3],20:[4,3],21:[5,3],22:[6,3],23:[7,3],24:[8,3],25:[1,1],26:[2,1],27:[3,1],28:[4,1],29:[1,2],30:[2,2],31:[3,2],32:[4,2],33:[1,3],34:[2,3],35:[3,3],36:[4,3],37:[1,1],38:[2,1],39:[1,2],40:[2,2],41:[1,3],42:[2,3],43:[1,1],44:[1,2],45:[1,3]},FIRST_MATCH={qf:0,sf:12,f:18},OCTO_FIRST_MATCH={ef:0,qf:24,sf:36,f:42};var COMP_LEVELS_PLAY_ORDER={qm:1,ef:2,qf:3,sf:4,f:5};function setCookie(name,value){document.cookie=name+"="+value}function getCookie(name){for(var name=name+"=",allCookies=document.cookie.split(";"),i=0;i<allCookies.length;i++){for(var c=allCookies[i];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(name))return c.substring(name.length,c.length)}return""}function playoffTypeFromNumber(matchNum,is_octo){return is_octo?0<matchNum&&matchNum<=24?"ef":24<matchNum&&matchNum<=36?"qf":36<matchNum&&matchNum<=42?"sf":"f":0<matchNum&&matchNum<=12?"qf":12<matchNum&&matchNum<=18?"sf":"f"}function playoffTypeFromMatchString(matchString){return matchString.includes("Octofinal")?"ef":matchString.includes("Quarterfinal")?"qf":matchString.includes("Semifinal")?"sf":matchString.includes("Final")?"f":null}function playoffTypeMatchAndSet(is_octo,match_string,last_type){var match_type=playoffTypeFromMatchString(match_string);if(null==match_type)return[match_type=last_type,parseInt(match_string.split(" ")[1]),3];var schedule_number=parseInt(match_string.split(" ")[1]),match_and_set=playoffMatchAndSet((is_octo?OCTO_FIRST_MATCH[match_type]:FIRST_MATCH[match_type])+schedule_number,is_octo);return[match_type,match_and_set[0],match_and_set[1]]}function playoffMatchAndSet(totalMatchNum,is_octo){return is_octo?OCTO_ELIM_MAPPING[totalMatchNum]:ELIM_MAPPING[totalMatchNum]}var valid_events=[];function update_fmsrankings_enabled(){$(".update-rankings").each(function(){$(this).prop("disabled",!$("#enable_fms_rankings").is(":checked"))})}$.get("/_/account/apiwrite_events",function(data){var key_select=$("#event_key_select"),selected=key_select.val();valid_events.push('<option value="">Select Event</option>'),$.each(JSON.parse(data),function(i,event){valid_events.push('<option value="'+event.value+'">'+event.label+"</option>")}),valid_events.push('<option value="other">Other</option>'),key_select.html(valid_events.join("")).val(selected),"other"!=selected&&($("#auth_id").val(""),$("#auth_secret").val(""),$("#event_key").hide(),$("#auth-tools").hide(),$("#auth-container").hide())}),"other"!=$("#event_key_select").val()&&$("#event_key").hide(),$("#event_key_select").change(function(){var eventKey=$(this).val();$("#event_key").val(eventKey),"other"==eventKey?($("#event_key").val("").show(),$("#auth-container").show(),$("#auth-tools").show()):($("#event_key").hide(),$("#auth-container").hide(),$("#auth-tools").hide()),$("#auth_id").val(""),$("#auth_secret").val("")}),$("#load_auth").click(function(){var eventKey=$("#event_key").val();if(!eventKey)return alert("You must select an event."),!1;var cookie=getCookie(eventKey+"_auth");if(!cookie)return alert("No auth found"),!1;var auth=JSON.parse(cookie);$("#auth_id").val(auth.id),$("#auth_secret").val(auth.secret)}),$("#store_auth").click(function(){var eventKey=$("#event_key").val(),authId=$("#auth_id").val(),authSecret=$("#auth_secret").val();if(!eventKey)return alert("You must select an event."),!1;if(!authId||!authSecret)return alert("You must enter your auth id and secret."),!1;var auth={};auth.id=authId,auth.secret=authSecret,setCookie(eventKey+"_auth",JSON.stringify(auth)),alert("Auth stored!")}),generateAllianceTable(8,$("#alliances tr:last")),$(".pick-3").hide(),$('input[name="alliance-size"]:radio').change(function(){var size=$(this).val();"2"==size?($(".pick-2").val("").hide(),$(".pick-3").val("").hide()):"3"==size?($(".pick-2").show(),$(".pick-3").val("").hide()):"4"==size&&($(".pick-2").show(),$(".pick-3").show())}),$("#auth-help").hide(),$("#show-help").click(function(){$("#auth-help").attr("display","inline").show()}),$("#enable_fms_rankings").change(function(){update_fmsrankings_enabled()}),$("#teams_preview").hide(),$("#fmsteams-ok").hide(),$("#schedule_preview").hide(),$("#schedule-ok").hide(),$("#results_preview").hide(),$("#results-ok").hide(),$("#rankings_preview").hide(),$("#rankings-ok").hide(),$("#fetch-matches").click(function(e){e.preventDefault(),$("#match_play_load_status").html("Loading matches"),$.ajax({url:"/api/v2/event/"+$("#event_key").val()+"/matches",dataType:"json",headers:{"X-TBA-App-Id":"tba-web:match-input:v01"},success:function(matches){$("#match-table").empty(),$("#match_play_load_status").html("Loaded "+matches.length+" matches");var tabIndex=1;for(i in matches){(match=matches[i]).play_order=1e6*COMP_LEVELS_PLAY_ORDER[match.comp_level]+1e3*match.match_number+match.set_number}for(i in matches.sort(function(a,b){return a.play_order-b.play_order}),matches){var match=matches[i],trRed=$("<tr>");for(j in trRed.append($("<td>",{rowspan:2,text:match.key.split("_")[1],style:"border-top-width: 4px;border-left-width:4px;border-bottom-width:4px;"})),match.alliances.red.teams)trRed.append($("<td>",{class:"red","data-matchKey-redTeam":match.key,text:match.alliances.red.teams[j].substring(3),style:"border-top-width:4px;"}));trRed.append($("<td>",{style:"background-color: #FF9999;border-top-width:4px;"}).append($("<input>",{id:match.key+"-redScore",type:"number",value:match.alliances.red.score,tabIndex:tabIndex}).css("max-width","50px"))),trRed.append($("<td>",{rowspan:2,style:"border-top-width: 4px;border-right-width:4px;border-bottom-width:4px;width:17%"}).append($("<input>",{id:match.key+"_video",placeholder:"YouTube URL"}))),trRed.append($("<td>",{rowspan:2,style:"border-top-width: 4px;border-right-width:4px;border-bottom-width:4px;width:17%"}).append($("<button>",{class:"update-match","data-matchKey":match.key,"data-matchCompLevel":match.comp_level,"data-matchSetNumber":match.set_number,"data-matchNumber":match.match_number,text:"SUBMIT - "+match.key.split("_")[1],tabIndex:tabIndex+2}))),trRed.append($("<td>",{rowspan:2,style:"border-top-width: 4px;border-right-width:4px;border-bottom-width:4px;width:17%"}).append($("<button>",{class:"update-rankings",text:"Update Rankings",tabIndex:tabIndex+3}))),$("#match-table").append(trRed);var trBlue=$("<tr>");for(j in match.alliances.blue.teams)trBlue.append($("<td>",{class:"blue","data-matchKey-blueTeam":match.key,text:match.alliances.blue.teams[j].substring(3),style:"border-bottom-width:4px;"}));trBlue.append($("<td>",{style:"background-color: #9999FF;border-bottom-width:4px;"}).append($("<input>",{id:match.key+"-blueScore",type:"number",value:match.alliances.blue.score,tabIndex:tabIndex+1}).css("max-width","50px"))),$("#match-table").append(trBlue),tabIndex+=4}update_fmsrankings_enabled()},error:function(data){alert("Something went wrong! Please check your Event Key.")}})});
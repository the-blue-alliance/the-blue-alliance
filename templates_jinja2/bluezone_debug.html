{% extends "base.html" %}

{% block title %}Match Timeline - The Blue Alliance{% endblock %}

{% block meta_description %}Timeline of matches across all ongoing events{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-xs-12">
      <h1>Match Timeline</h1>

      <div id="timeline"></div>
    </div>
  </div>
</div>
{% endblock %}


{% block inline_javascript %}
<script type="text/javascript">
  var container = document.getElementById('timeline');

  // create a data set with groups
  var groupNames = ['CASJ', 'CAIR', 'HIHO', 'IDBO', 'ILCH', 'MXTO', 'NYLI', 'OHCL', 'MELEW'];
  var groups = new vis.DataSet();
  for (var g = 0; g < groupNames.length; g++) {
    groups.add({id: '2017' + groupNames[g].toLowerCase(), content: groupNames[g]});
  }

  var timelineItems = new vis.DataSet([]);

  // Configuration for the Timeline
  var options = {
    rollingMode: true,
    zoomMin: 1000 * 60 * 20,  // 20 min
    zoomMax: 1000 * 60 * 60,  // 60 min
    // zoomMax: 1000 * 60 * 60 * 24 * 7,  // One week
  };

  // Create a Timeline
  var timeline = new vis.Timeline(container, timelineItems, groups, options);

  // Subscribe to Firebase
  for (var groupName in groupNames) {
    var eventRef = firebase.database().ref('events/2017' + groupNames[groupName].toLowerCase() + '/matches');
    eventRef.on('value', function(snapshot) {
      var matches = snapshot.val();
      for (var matchKey in matches) {
        var match = matches[matchKey];
        var time;
        if (match.actual_time) {
          time = match.actual_time;
        } else if (match.predicted_time) {
          time = match.predicted_time;
        } else {
          time = match.time;
        }
        time += 60 * 60 * 24 * 11;  // TODO TEMP shift to now
        var eventKey = match.key.split('_')[0];
        var matchShort;
        if (match.comp_level == 'qm') {
          matchShort = 'Q' + match.match_number;
        } else {
          matchShort = match.comp_level.toUpperCase() + match.set_number + '-' + match.match_number;
        }

        // Format content
        var content = '<b>' + matchShort + '</b>' + '<br>' + '500, 50%, 30%' + '<br>' + '500, 50%, 30%';

        var timelineItem = {
          id: match.key,
          group: eventKey,
          content: content,
          start: new Date(time * 1000).toISOString(),
          end: new Date((time + 150) * 1000).toISOString(),
        };
        timelineItems.update(timelineItem);
      }
    });
    eventRef.on('child_removed', function(snapshot) {
      var removedMatch = snapshot.val();
      timelineItems.remove(removedMatch.key);
    });
  }
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Nearby - The Blue Alliance{% endblock %}

{% block meta_description %}Search for nearby teams and events{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-xs-12">
      <h1>Search for nearby teams and events</h1>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-10 col-sm-offset-1">
      <form id="location-search" class="form-inline" method="get">
        <div class="form-group">
          <label class="sr-only" for="input-year">Year</label>
          <select class="form-control" id="input-year" name="year">
            {% for valid_year in valid_years %}
              <option value="{{valid_year}}"{% if valid_year == year %} selected="selected"{% endif %}">{{valid_year}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label class="sr-only" for="input-location">Location</label>
          <input type="text" class="form-control" id="input-location" name="location" placeholder="City / Zip / Address"{% if location %} value="{{location}}"{% endif %}">
        </div>
        <select class="form-control" id="input-range-limit" name="range_limit">
          {% for valid_range in valid_ranges %}
            <option value="{{valid_range}}"{% if range_limit == valid_range %} selected="selected"{% endif %}">Within {{valid_range}} km</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-success"><span class="glyphicon glyphicon-search"></span> Search</button>
      </form>
      <br>
    </div>
  </div>

  <div class="row">
    <div class="col-sm-10 col-sm-offset-1">
      {% if location %}
        {% if events %}
          <p class="pull-right">{{num_results}} events found within {{range_limit}} km</p>

          {% if num_results > page_size %}
            <nav aria-label="Page navigation">
              <ul class="pagination">
                {% if page != 0 %}
                <li>
                  <a href="/nearby?year={{year}}&location={{location}}&page={{page - 1}}&range_limit={{range_limit}}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                {% endif %}
                {% for i in range((num_results / page_size)|ceil) %}
                  <li {% if i == page %}class="active"{% endif %}>
                    <a href="/nearby?year={{year}}&location={{location}}&page={{i}}&range_limit={{range_limit}}">
                      {{page_size * i + 1}}-
                      {%- if loop.last -%}
                        {{page_size * i + num_results - page_size * i}}
                      {%- else -%}
                        {{page_size * i + page_size}}
                      {% endif %}
                    </a>
                  </li>
                {% endfor %}
                {% if page != (num_results / page_size)|ceil - 1 %}
                <li>
                  <a href="/nearby?year={{year}}&location={{location}}&page={{page + 1}}&range_limit={{range_limit}}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}

          <table class="event-table">
            <thead>
              <tr>
                <th>Event</th>
                <th>Dates</th>
                <th>Distance</th>
              </tr>
            </thead>
            <tbody>
              {% for event in events %}
                <tr>
                  <td>
                    <a href="/event/{{event.key_name}}" title="{{event.name}}" itemprop="url"><span itemprop="summary">{{event.name}}</span></a>
                    {% if event.location %}
                      <br>
                      <small>{{event.location}}</small>
                    {% endif %}
                  </td>
                  <td>
                    {% if event.start_date %}<time itemprop="startDate" datetime="{{event.start_date|strftime("%c")}}">{{ event.start_date|strftime("%b %d") }}{% if event.start_date.date() != event.end_date.date() %}</time> to <time itemprop="endDate" datetime="{{event.end_date|strftime("%c")}}">{{ event.end_date|strftime("%b %d") }}{% endif %}{{ event.end_date|strftime(", %Y") }}</time>{% endif %}
                  </td>
                  <td>
                    {{(distances[event.key.id()] / 1000)|round|int}} km
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No events were found matching the search criteria. Try picking another location or increasing the search range.</p>
        {% endif %}
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
